{% extends 'base.html' %}

{% block content %}

<body class="is-preload">

    <div class="pull-right" style="margin-top: 15px;">
        {% if revision %}
        <a href="{% url 'editrevision' project.id assembly.id part.id revision.id %}" class="btn btn-success btn-small">
            <i class="icon-white icon-cog"></i> Edit Revision
        </a>
        <a href="{% url 'newrevision' project.id assembly.id part.id %}" class="btn btn-primary btn-small">
            <i class="icon-white icon-plus"></i> New Revision
        </a>
        {% if can_delete_revisions and revisions|length > 1 %}
        <a href="#" onclick="confirmDeleteRevision()" class="btn btn-danger btn-small">
            <i class="icon-white icon-trash"></i> Delete Revision
        </a>
        {% endif %}
        {% else %}
        <a href="edit" class="btn btn-success btn-small">
            <i class="icon-white icon-cog"></i> Edit Part
        </a>
        {% endif %}
    </div>
    <h2>{{ part.name }} - Details</h2>
    
    {% if revisions %}
    <div class="revision-selector" style="margin-bottom: 20px;">
        <label for="revision-select"><strong>Revision:</strong></label>
        <select id="revision-select" onchange="changeRevision()">
            {% for rev in revisions %}
            <option value="{% url 'part_revision' project.id assembly.id part.id rev.id %}" 
                    {% if revision and rev.id == revision.id %}selected{% elif not revision and forloop.first %}selected{% endif %}>
                Rev {{ rev.revision_number }} - {{ rev.get_status_display }}
            </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div>
        <a href="/projects/{{ project.id }}"><b>{{ project.name }}</b></a>
        {% if part.assembly %}
        <i class="icon-chevron-right"></i> {{ part.assembly }}
        {% endif %}
        <i class="icon-chevron-right"></i> <b>{{ part.name }}</b>
    </div>
    <br />

    <div class="grid-container" style="margin: 0;">
        <div style="padding-right: 15px;">
            <table class="table table-striped table-condensed table-bordered" style="width: auto;">
                <tr>
                  <td><b>Project</b></td>
                  <td><a href="/projects/{{ project.id }}">{{ project.name }}</a></td>
                </tr>
                <tr><td><b>Part Number</b></td><td>{{ part.part_number }}</td></tr>
                {% if revision %}
                <tr><td><b>Revision</b></td><td>{{ revision.revision_number }}</td></tr>
                <tr>
                  <td><b>Status</b></td>
                  <td>
                    <span class="label label-status-{{ revision.status }}">{{ revision.get_status_display }}</span>
                  </td>
                </tr>
                <tr>
                  <td><b>Assignee</b></td>
                  <td>{{ revision.owner|default:"Unassigned" }}</td>
                </tr>
                <tr><td><b>Source material</b></td><td>{{ revision.material|default:"Not specified" }}</td></tr>
                <tr><td><b>Quantity required</b></td><td>{{ revision.quantity|default:"Not specified" }}</td></tr>
                <tr><td><b>Manufacturing method</b></td><td>{{ revision.get_mfg_type_display|default:"Not specified" }}</td></tr>
                        <tr><td><b>Drawing</b></td><td>
                            {% if revision.drawing %}
                                {% with file_name=revision.drawing.name|lower %}
                                    {% if '.pdf' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download PDF</a>
                                    {% elif '.dwg' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download DWG</a>
                                    {% elif '.dxf' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download DXF</a>
                                    {% elif '.stl' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download STL</a>
                                    {% elif '.step' in file_name or '.stp' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download STEP</a>
                                    {% elif '.iges' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download IGES</a>
                                    {% elif '.gcode' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download G-Code</a>
                                    {% elif '.nc' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download G-Code</a>
                                    {% elif '.jpg' in file_name or '.jpeg' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download JPEG</a>
                                    {% elif '.png' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download PNG</a>
                                    {% elif '.gif' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download GIF</a>
                                    {% elif '.bmp' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download BMP</a>
                                    {% elif '.tiff' in file_name %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download TIFF</a>
                                    {% else %}
                                        <a href="{{ revision.drawing.url }}" target="_blank">Download File</a>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                No drawing
                            {% endif %}
                        </td></tr>
                <tr><td><b>Created</b></td><td>{{ revision.created_at|date:"M d, Y H:i" }}</td></tr>
                <tr><td><b>Updated</b></td><td>{{ revision.updated_at|date:"M d, Y H:i" }}</td></tr>
                {% if revision.notes %}
                <tr><td><b>Notes</b></td><td>{{ revision.notes }}</td></tr>
                {% endif %}
                {% else %}
                <tr><td><b>Status</b></td><td>No revisions available</td></tr>
                {% endif %}
              </table>
        </div>
        
        <div style="padding-left: 15px;">
            {% if revision and revision.drawing %}
            <div class="drawing-preview-panel">
                <h4>Drawing Preview</h4>
                <div id="previewContainer" style="width: 100%; height: 500px; position: relative; border: 1px solid #ddd; border-radius: 4px;">
                    <div id="loadingSpinner" class="text-center" style="padding: 50px;">
                        <i class="icon-spinner icon-spin"></i> Loading preview...
                    </div>
                    <div id="previewContent" style="display: none;">
                        <!-- 3D Viewer Container -->
                        <div id="threejs-container" style="width: 100%; height: 100%; display: none;"></div>
                        <!-- 2D Image/PDF Container -->
                        <div id="image-container" style="width: 100%; height: 100%; display: none; text-align: center;">
                            <img id="preview-image" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                        </div>
                        <!-- PDF Container -->
                        <div id="pdf-container" style="width: 100%; height: 100%; display: none;">
                            <iframe id="pdf-viewer" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                    <div id="previewError" style="display: none; text-align: center; padding: 50px; color: #d9534f;">
                        <i class="icon-exclamation-sign"></i> Preview not available for this file type
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <a href="{{ revision.drawing.url }}" target="_blank" class="btn btn-primary btn-sm">
                        <i class="icon-download"></i> Download Original
                    </a>
                </div>
            </div>
            {% else %}
            <div class="drawing-preview-panel">
                <h4>Drawing Preview</h4>
                <div style="width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9;">
                    <p class="text-muted">No drawing available</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>


    <style>
    /* Fallback for browsers that don't support CSS Grid */
    .grid-container {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
    }
    
    .grid-container > div {
        -webkit-box-flex: 1;
        -ms-flex: 1;
        flex: 1;
    }
    
    /* CSS Grid for modern browsers */
    @supports (display: grid) {
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .grid-container > div {
            flex: none;
        }
    }
    
    @media (max-width: 768px) {
        .grid-container {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
            -webkit-box-orient: vertical !important;
            -webkit-box-direction: normal !important;
            -ms-flex-direction: column !important;
            flex-direction: column !important;
        }
    }
    </style>

    <script>
    function changeRevision() {
        var select = document.getElementById('revision-select');
        var url = select.value;
        window.location.href = url;
    }
    
    function confirmDeleteRevision() {
        if (confirm('Are you sure you want to delete this revision? This action cannot be undone.')) {
            window.location.href = "{% url 'deleterevision' project.id assembly.id part.id revision.id %}";
        }
    }

    // Auto-load drawing preview when page loads
    {% if revision and revision.drawing %}
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Loading preview for:', '{{ revision.drawing.name }}');
        
        // Add a small delay to ensure container is properly sized
        setTimeout(function() {
            loadPreview('{{ revision.drawing.url }}', '{{ revision.drawing.name }}');
        }, 100);
        
        // Add a timeout to show something if preview fails
        setTimeout(function() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner && loadingSpinner.style.display !== 'none') {
                console.log('Preview loading timeout - showing fallback');
                showPreviewError();
            }
        }, 10000); // 10 second timeout
    });
    {% endif %}

    function loadPreview(fileUrl, fileName) {
        console.log('loadPreview called with:', fileUrl, fileName);
        
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');
        const previewError = document.getElementById('previewError');
        const threejsContainer = document.getElementById('threejs-container');
        const imageContainer = document.getElementById('image-container');
        const pdfContainer = document.getElementById('pdf-container');

        console.log('Elements found:', {
            loadingSpinner: !!loadingSpinner,
            previewContent: !!previewContent,
            previewError: !!previewError,
            threejsContainer: !!threejsContainer,
            imageContainer: !!imageContainer,
            pdfContainer: !!pdfContainer
        });

        // Reset display
        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (previewContent) previewContent.style.display = 'none';
        if (previewError) previewError.style.display = 'none';
        if (threejsContainer) threejsContainer.style.display = 'none';
        if (imageContainer) imageContainer.style.display = 'none';
        if (pdfContainer) pdfContainer.style.display = 'none';

        // Get file extension
        const fileExtension = fileName.split('.').pop().toLowerCase();
        console.log('File extension:', fileExtension);
        
        // Only show preview for three.js supported formats (including STL with custom loader)
        const threejsSupportedFormats = ['stl', 'gltf', 'glb', 'obj', 'fbx', 'dae', '3ds', 'ply', 'svg'];
        
        if (threejsSupportedFormats.includes(fileExtension)) {
            console.log('Loading 3D preview for three.js supported format:', fileExtension);
            load3DPreview(fileUrl, fileExtension);
        } else {
            console.log('File type not supported by three.js, showing download-only message');
            showDownloadOnlyMessage(fileUrl, fileExtension);
        }
    }

    function showDownloadOnlyMessage(fileUrl, fileExtension) {
        console.log('Showing download-only message for:', fileExtension);
        
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');
        const threejsContainer = document.getElementById('threejs-container');
        
        // Create download-only container
        const downloadContainer = document.createElement('div');
        downloadContainer.style.cssText = 'width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; padding: 20px; text-align: center;';
        
        // Create file type icon
        const iconDiv = document.createElement('div');
        iconDiv.style.cssText = 'font-size: 64px; margin-bottom: 20px; opacity: 0.9;';
        
        // Set appropriate icon based on file type
        if (['pdf'].includes(fileExtension)) {
            iconDiv.innerHTML = 'üìÑ';
        } else if (['dwg', 'dxf'].includes(fileExtension)) {
            iconDiv.innerHTML = 'üèóÔ∏è';
        } else if (['step', 'stp', 'iges'].includes(fileExtension)) {
            iconDiv.innerHTML = '‚öôÔ∏è';
        } else if (['nc', 'gcode'].includes(fileExtension)) {
            iconDiv.innerHTML = 'üîß';
        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff'].includes(fileExtension)) {
            iconDiv.innerHTML = 'üñºÔ∏è';
        } else {
            iconDiv.innerHTML = 'üìÅ';
        }
        
        // Create title
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = 'font-size: 24px; font-weight: bold; margin-bottom: 12px;';
        titleDiv.textContent = fileExtension.toUpperCase() + ' File';
        
        // Create description
        const descDiv = document.createElement('div');
        descDiv.style.cssText = 'font-size: 16px; margin-bottom: 20px; opacity: 0.9; line-height: 1.4;';
        descDiv.innerHTML = 'This file type is not supported for web preview.<br/>Download the file to view in appropriate software.';
        
        // Create button container
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;';
        
        // Download button
        const downloadBtn = document.createElement('a');
        downloadBtn.href = fileUrl;
        downloadBtn.target = '_blank';
        downloadBtn.className = 'btn btn-light btn-sm';
        downloadBtn.style.cssText = 'color: #667eea; font-weight: bold;';
        downloadBtn.innerHTML = '<i class="icon-download"></i> Download ' + fileExtension.toUpperCase();
        
        // Info button
        const infoBtn = document.createElement('button');
        infoBtn.className = 'btn btn-outline-light btn-sm';
        infoBtn.style.cssText = 'border: 2px solid white; color: white; font-weight: bold;';
        infoBtn.innerHTML = '<i class="icon-info-sign"></i> View Info';
        infoBtn.onclick = () => showFileTypeInfo(fileExtension);
        
        buttonContainer.appendChild(downloadBtn);
        buttonContainer.appendChild(infoBtn);
        
        // Assemble the container
        downloadContainer.appendChild(iconDiv);
        downloadContainer.appendChild(titleDiv);
        downloadContainer.appendChild(descDiv);
        downloadContainer.appendChild(buttonContainer);
        
        // Replace the 3D container content with download-only message
        if (threejsContainer) {
            threejsContainer.innerHTML = '';
            threejsContainer.appendChild(downloadContainer);
            threejsContainer.style.display = 'block';
        }
        
        if (loadingSpinner) loadingSpinner.style.display = 'none';
        if (previewContent) previewContent.style.display = 'block';
        
        console.log('Download-only message displayed for:', fileExtension);
    }
    
    function showFileTypeInfo(fileExtension) {
        let message = '';
        
        switch(fileExtension) {
            case 'pdf':
                message = 'PDF Document Information:\n\n' +
                         'PDF files contain technical drawings and documentation:\n' +
                         '‚Ä¢ Engineering drawings and blueprints\n' +
                         '‚Ä¢ Technical specifications\n' +
                         '‚Ä¢ Assembly instructions\n\n' +
                         'To view: Download and open in Adobe Reader or browser.';
                break;
            case 'dwg':
                message = 'DWG File Information:\n\n' +
                         'DWG files are AutoCAD drawing files:\n' +
                         '‚Ä¢ 2D and 3D CAD drawings\n' +
                         '‚Ä¢ Engineering and architectural plans\n' +
                         '‚Ä¢ Technical documentation\n\n' +
                         'To view: Use AutoCAD, DraftSight, or other CAD software.';
                break;
            case 'dxf':
                message = 'DXF File Information:\n\n' +
                         'DXF files are CAD data exchange format:\n' +
                         '‚Ä¢ 2D and 3D drawing data\n' +
                         '‚Ä¢ Compatible with most CAD software\n' +
                         '‚Ä¢ Industry standard format\n\n' +
                         'To view: Use AutoCAD, FreeCAD, or other CAD software.';
                break;
            case 'step':
            case 'stp':
                message = 'STEP File Information:\n\n' +
                         'STEP files are 3D CAD exchange format:\n' +
                         '‚Ä¢ 3D solid models and assemblies\n' +
                         '‚Ä¢ Industry standard for CAD data exchange\n' +
                         '‚Ä¢ Used for manufacturing and engineering\n\n' +
                         'To view: Use CAD software like SolidWorks, Fusion 360, or FreeCAD.';
                break;
            case 'iges':
                message = 'IGES File Information:\n\n' +
                         'IGES files are CAD data exchange format:\n' +
                         '‚Ä¢ 2D and 3D geometry data\n' +
                         '‚Ä¢ Legacy format still widely used\n' +
                         '‚Ä¢ Engineering and manufacturing data\n\n' +
                         'To view: Use CAD software like SolidWorks, Fusion 360, or FreeCAD.';
                break;
            case 'nc':
            case 'gcode':
                message = 'G-Code File Information:\n\n' +
                         'G-code files contain CNC machine instructions:\n' +
                         '‚Ä¢ Tool paths and movements\n' +
                         '‚Ä¢ Spindle speeds and feed rates\n' +
                         '‚Ä¢ Tool changes and positioning\n\n' +
                         'To view: Use CAM software or G-code viewers.';
                break;
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
            case 'bmp':
            case 'tiff':
                message = 'Image File Information:\n\n' +
                         'Image files contain visual data:\n' +
                         '‚Ä¢ Photographs and graphics\n' +
                         '‚Ä¢ Technical drawings and diagrams\n' +
                         '‚Ä¢ Documentation and reference images\n\n' +
                         'To view: Use any image viewer or web browser.';
                break;
            default:
                message = 'File Type Information:\n\n' +
                         'This file type requires specialized software to view:\n' +
                         '‚Ä¢ Download the file to your computer\n' +
                         '‚Ä¢ Use appropriate software for the file type\n' +
                         '‚Ä¢ Check file documentation for recommended viewers';
        }
        
        alert(message);
    }

    function createPlaceholderGeometry(scene, fileType, color) {
        // Create a placeholder geometry with text
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshLambertMaterial({ color: color });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
        
        // Add text indicating the file type
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 64;
        context.fillStyle = '#000000';
        context.font = '16px Arial';
        context.fillText(fileType + ' Preview', 10, 35);
        
        const texture = new THREE.CanvasTexture(canvas);
        const textMaterial = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
        const textGeometry = new THREE.PlaneGeometry(2, 0.5);
        const textMesh = new THREE.Mesh(textGeometry, textMaterial);
        textMesh.position.set(0, 0, 0.6);
        scene.add(textMesh);
        
        // Show the preview - get elements again to ensure they're accessible
        let placeholderLoadingSpinner = document.getElementById('loadingSpinner');
        let placeholderPreviewContent = document.getElementById('previewContent');
        let placeholderThreejsContainer = document.getElementById('threejs-container');
        
        if (placeholderLoadingSpinner) placeholderLoadingSpinner.style.display = 'none';
        if (placeholderPreviewContent) placeholderPreviewContent.style.display = 'block';
        if (placeholderThreejsContainer) placeholderThreejsContainer.style.display = 'block';
    }


    function load3DPreview(fileUrl, fileExtension) {
        console.log('load3DPreview called with:', fileUrl, fileExtension);
        
        // Load Three.js dynamically
        if (!window.THREE) {
            console.log('THREE.js not loaded, loading it now...');
            const threeScript = document.createElement('script');
            threeScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
            threeScript.onload = () => {
                console.log('THREE.js loaded successfully');
                loadThreeJSLoader(fileUrl, fileExtension);
            };
            threeScript.onerror = (error) => {
                console.error('Failed to load THREE.js:', error);
                showPreviewError();
            };
            document.head.appendChild(threeScript);
        } else {
            console.log('THREE.js already loaded');
            loadThreeJSLoader(fileUrl, fileExtension);
        }
    }

    function loadThreeJSLoader(fileUrl, fileExtension) {
        console.log('loadThreeJSLoader called with:', fileUrl, fileExtension);
        
        // Load STLLoader for STL files
        if (fileExtension === 'stl' && !window.STLLoader) {
            console.log('STLLoader not available, loading it now...');
            const stlScript = document.createElement('script');
            stlScript.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js';
            stlScript.onload = () => {
                console.log('STLLoader loaded successfully');
                init3DViewer(fileUrl, fileExtension);
            };
            stlScript.onerror = (error) => {
                console.error('Failed to load STLLoader:', error);
                console.log('Falling back to placeholder geometry');
                init3DViewer(fileUrl, fileExtension);
            };
            document.head.appendChild(stlScript);
        } else {
            console.log('Initializing 3D viewer for three.js supported format:', fileExtension);
            init3DViewer(fileUrl, fileExtension);
        }
    }





    function init3DViewer(fileUrl, fileExtension) {
        console.log('init3DViewer called with:', fileUrl, fileExtension);
        
        let container = document.getElementById('threejs-container');
        let loadingSpinner = document.getElementById('loadingSpinner');
        let previewContent = document.getElementById('previewContent');
        let threejsContainer = document.getElementById('threejs-container');

        console.log('3D viewer elements:', {
            container: !!container,
            loadingSpinner: !!loadingSpinner,
            previewContent: !!previewContent,
            containerSize: container ? { width: container.offsetWidth, height: container.offsetHeight } : 'N/A'
        });

        // Clear previous scene
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        // Create scene
        const scene = new THREE.Scene();
        const containerWidth = container.offsetWidth || 400;
        const containerHeight = container.offsetHeight || 400;
        const camera = new THREE.PerspectiveCamera(75, containerWidth / containerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        
        console.log('Three.js objects created:', { scene, camera, renderer });
        
        console.log('Setting renderer size to:', containerWidth, 'x', containerHeight);
        
        renderer.setSize(containerWidth, containerHeight);
        renderer.setClearColor(0xf0f0f0);
        container.appendChild(renderer.domElement);
        
        // Update camera aspect ratio
        camera.aspect = containerWidth / containerHeight;
        camera.updateProjectionMatrix();

        // Add lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // Handle different 3D file types
        if (fileExtension === 'stl') {
            console.log('Processing STL file:', fileUrl);
            console.log('STLLoader available check:', !!window.STLLoader, 'THREE.STLLoader:', !!THREE.STLLoader);
            // Load actual STL file
            if (window.STLLoader || THREE.STLLoader) {
                console.log('STLLoader is available, loading STL file...');
                const loader = new THREE.STLLoader();
                loader.load(fileUrl, function(geometry) {
                    console.log('STL file loaded successfully, geometry:', geometry);
                    const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
                    const mesh = new THREE.Mesh(geometry, material);
                    
                    // Center and scale the model
                    geometry.computeBoundingBox();
                    const boundingBox = geometry.boundingBox;
                    const center = boundingBox.getCenter(new THREE.Vector3());
                    const size = boundingBox.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 2 / maxDim;
                    
                    console.log('STL bounding box:', { center, size, maxDim, scale });
                    
                    mesh.scale.setScalar(scale);
                    mesh.position.sub(center.multiplyScalar(scale));
                    
                    scene.add(mesh);
                    console.log('STL mesh added to scene');
                    
                            // Show the preview - get elements again to ensure they're accessible
                            let stlLoadingSpinner = document.getElementById('loadingSpinner');
                            let stlPreviewContent = document.getElementById('previewContent');
                            let stlThreejsContainer = document.getElementById('threejs-container');
                    
                    if (stlLoadingSpinner) stlLoadingSpinner.style.display = 'none';
                    if (stlPreviewContent) stlPreviewContent.style.display = 'block';
                    if (stlThreejsContainer) stlThreejsContainer.style.display = 'block';
                    console.log('STL preview displayed');
                }, function(progress) {
                    // Loading progress
                    console.log('STL loading progress:', (progress.loaded / progress.total * 100) + '%');
                }, function(error) {
                    console.error('STL loading error:', error);
                    showPreviewError();
                });
            } else {
                console.log('STLLoader not available, showing placeholder');
                // Fallback if STLLoader not available
                createPlaceholderGeometry(scene, 'STL', 0x00ff00);
            }
        } else {
            // For other three.js supported formats, show placeholder with appropriate color
            let color = 0x666666;
            if (fileExtension === 'gltf' || fileExtension === 'glb') color = 0x00ccff;
            else if (fileExtension === 'obj') color = 0xff6600;
            else if (fileExtension === 'fbx') color = 0xcc00ff;
            else if (fileExtension === 'dae') color = 0xffcc00;
            else if (fileExtension === '3ds') color = 0x00ffcc;
            else if (fileExtension === 'ply') color = 0xff0066;
            else if (fileExtension === 'svg') color = 0x66ff00;
            
            createPlaceholderGeometry(scene, fileExtension.toUpperCase(), color);
        }

        camera.position.z = 3;

        // Add controls for rotation
        let mouseX = 0, mouseY = 0;
        let isMouseDown = false;

        container.addEventListener('mousedown', (event) => {
            isMouseDown = true;
        });

        container.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        container.addEventListener('mousemove', (event) => {
            if (isMouseDown) {
                mouseX = (event.clientX / container.offsetWidth) * 2 - 1;
                mouseY = -(event.clientY / container.offsetHeight) * 2 + 1;
                
                // Rotate the first mesh in the scene
                if (scene.children.length > 0) {
                    const mesh = scene.children.find(child => child instanceof THREE.Mesh);
                    if (mesh) {
                        mesh.rotation.y = mouseX * Math.PI;
                        mesh.rotation.x = mouseY * Math.PI;
                    }
                }
            }
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // Store scene reference for cleanup
        window.scene = scene;

        // For non-STL files, show the preview immediately
        if (fileExtension !== 'stl') {
            // Show the preview
            loadingSpinner.style.display = 'none';
            previewContent.style.display = 'block';
            threejsContainer.style.display = 'block';
        }
    }


    function showPreviewError() {
        console.log('showPreviewError called');
        
        let loadingSpinner = document.getElementById('loadingSpinner');
        let previewError = document.getElementById('previewError');
        
        console.log('Error elements:', {
            loadingSpinner: !!loadingSpinner,
            previewError: !!previewError
        });
        
        if (loadingSpinner) loadingSpinner.style.display = 'none';
        if (previewError) previewError.style.display = 'block';
    }

    </script>

    {% endblock content %}