{% extends 'base.html' %}

{% block content %}

<body class="is-preload">

    <div class="pull-right" style="margin-top: 15px;">
        {% if revision %}
        <a href="{% url 'editrevision' project.id assembly.id part.id revision.id %}" class="btn btn-success btn-small">
            <i class="icon-white icon-cog"></i> Edit Revision
        </a>
        <a href="{% url 'newrevision' project.id assembly.id part.id %}" class="btn btn-primary btn-small">
            <i class="icon-white icon-plus"></i> New Revision
        </a>
        {% if can_delete_revisions and revisions|length > 1 %}
        <a href="#" onclick="confirmDeleteRevision()" class="btn btn-danger btn-small">
            <i class="icon-white icon-trash"></i> Delete Revision
        </a>
        {% endif %}
        {% else %}
        <a href="edit" class="btn btn-success btn-small">
            <i class="icon-white icon-cog"></i> Edit Part
        </a>
        {% endif %}
    </div>
    <h2>{{ part.name }} - Details</h2>
    
    {% if revisions %}
    <div class="revision-selector" style="margin-bottom: 20px;">
        <label for="revision-select"><strong>Revision:</strong></label>
        <select id="revision-select" onchange="changeRevision()">
            {% for rev in revisions %}
            <option value="{% url 'part_revision' project.id assembly.id part.id rev.id %}" 
                    {% if revision and rev.id == revision.id %}selected{% elif not revision and forloop.first %}selected{% endif %}>
                Rev {{ rev.revision_number }} - {{ rev.get_status_display }}
            </option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div>
        <a href="/projects/{{ project.id }}"><b>{{ project.name }}</b></a>
        {% if part.assembly %}
        <i class="icon-chevron-right"></i> {{ part.assembly }}
        {% endif %}
        <i class="icon-chevron-right"></i> <b>{{ part.name }}</b>
    </div>
    <br />

    <table class="table table-striped table-condensed table-bordered" style="width: auto;">
        <tr>
          <td><b>Project</b></td>
          <td><a href="/projects/{{ project.id }}">{{ project.name }}</a></td>
        </tr>
        <tr><td><b>Part Number</b></td><td>{{ part.part_number }}</td></tr>
        {% if revision %}
        <tr><td><b>Revision</b></td><td>{{ revision.revision_number }}</td></tr>
        <tr>
          <td><b>Status</b></td>
          <td>
            <span class="label label-status-{{ revision.status }}">{{ revision.get_status_display }}</span>
          </td>
        </tr>
        <tr>
          <td><b>Assignee</b></td>
          <td>{{ revision.owner|default:"Unassigned" }}</td>
        </tr>
        <tr><td><b>Source material</b></td><td>{{ revision.material|default:"Not specified" }}</td></tr>
        <tr><td><b>Quantity required</b></td><td>{{ revision.quantity|default:"Not specified" }}</td></tr>
        <tr><td><b>Manufacturing method</b></td><td>{{ revision.get_mfg_type_display|default:"Not specified" }}</td></tr>
        <tr><td><b>Drawing</b></td><td>
            {% if revision.drawing %}
                <a href="{{ revision.drawing.url }}" target="_blank">Download</a>
                <button type="button" class="btn btn-info btn-sm" onclick="togglePreview()" style="margin-left: 10px;">
                    <i class="icon-eye-open"></i> Preview
                </button>
            {% else %}
                No drawing
            {% endif %}
        </td></tr>
        <tr><td><b>Created</b></td><td>{{ revision.created_at|date:"M d, Y H:i" }}</td></tr>
        <tr><td><b>Updated</b></td><td>{{ revision.updated_at|date:"M d, Y H:i" }}</td></tr>
        {% if revision.notes %}
        <tr><td><b>Notes</b></td><td>{{ revision.notes }}</td></tr>
        {% endif %}
        {% else %}
        <tr><td><b>Status</b></td><td>No revisions available</td></tr>
        {% endif %}
      </table>

    <!-- Drawing Preview Modal -->
    {% if revision.drawing %}
    <div id="previewModal" class="modal" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Drawing Preview - {{ revision.drawing.name }}</h4>
                    <button type="button" class="close" onclick="closePreview()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="previewContainer" style="width: 100%; height: 500px; position: relative;">
                        <div id="loadingSpinner" class="text-center" style="padding: 50px;">
                            <i class="icon-spinner icon-spin"></i> Loading preview...
                        </div>
                        <div id="previewContent" style="display: none;">
                            <!-- 3D Viewer Container -->
                            <div id="threejs-container" style="width: 100%; height: 100%; display: none;"></div>
                            <!-- 2D Image/PDF Container -->
                            <div id="image-container" style="width: 100%; height: 100%; display: none; text-align: center;">
                                <img id="preview-image" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                            </div>
                            <!-- PDF Container -->
                            <div id="pdf-container" style="width: 100%; height: 100%; display: none;">
                                <iframe id="pdf-viewer" style="width: 100%; height: 100%; border: none;"></iframe>
                            </div>
                        </div>
                        <div id="previewError" style="display: none; text-align: center; padding: 50px; color: #d9534f;">
                            <i class="icon-exclamation-sign"></i> Preview not available for this file type
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" onclick="closePreview()">Close</button>
                    <a href="{{ revision.drawing.url }}" target="_blank" class="btn btn-primary">Download Original</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
    function changeRevision() {
        var select = document.getElementById('revision-select');
        var url = select.value;
        window.location.href = url;
    }
    
    function confirmDeleteRevision() {
        if (confirm('Are you sure you want to delete this revision? This action cannot be undone.')) {
            window.location.href = "{% url 'deleterevision' project.id assembly.id part.id revision.id %}";
        }
    }

    // Drawing Preview Functions
    function togglePreview() {
        {% if revision.drawing %}
        document.getElementById('previewModal').style.display = 'block';
        loadPreview('{{ revision.drawing.url }}', '{{ revision.drawing.name }}');
        {% endif %}
    }

    function closePreview() {
        document.getElementById('previewModal').style.display = 'none';
        // Clean up Three.js scene if it exists
        if (window.scene) {
            window.scene = null;
        }
    }

    function loadPreview(fileUrl, fileName) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');
        const previewError = document.getElementById('previewError');
        const threejsContainer = document.getElementById('threejs-container');
        const imageContainer = document.getElementById('image-container');
        const pdfContainer = document.getElementById('pdf-container');

        // Reset display
        loadingSpinner.style.display = 'block';
        previewContent.style.display = 'none';
        previewError.style.display = 'none';
        threejsContainer.style.display = 'none';
        imageContainer.style.display = 'none';
        pdfContainer.style.display = 'none';

        // Get file extension
        const fileExtension = fileName.split('.').pop().toLowerCase();
        
        // Determine preview type and load accordingly
        if (['stl', 'step', 'stp', 'iges'].includes(fileExtension)) {
            load3DPreview(fileUrl, fileExtension);
        } else if (['pdf'].includes(fileExtension)) {
            loadPDFPreview(fileUrl);
        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff'].includes(fileExtension)) {
            loadImagePreview(fileUrl);
        } else {
            showPreviewError();
        }
    }

    function load3DPreview(fileUrl, fileExtension) {
        // Load Three.js dynamically
        if (!window.THREE) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
            script.onload = () => init3DViewer(fileUrl, fileExtension);
            document.head.appendChild(script);
        } else {
            init3DViewer(fileUrl, fileExtension);
        }
    }

    function init3DViewer(fileUrl, fileExtension) {
        const container = document.getElementById('threejs-container');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');

        // Clear previous scene
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        // Create scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.setClearColor(0xf0f0f0);
        container.appendChild(renderer.domElement);

        // Add lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // For STL files, we'll create a simple placeholder since we can't load STL directly in browser
        // In a real implementation, you'd use a library like three-stl-loader
        if (fileExtension === 'stl') {
            // Create a placeholder geometry for STL files
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);
            
            // Add text indicating this is a placeholder
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            context.fillStyle = '#000000';
            context.font = '16px Arial';
            context.fillText('STL Preview (Placeholder)', 10, 35);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
            const textGeometry = new THREE.PlaneGeometry(2, 0.5);
            const textMesh = new THREE.Mesh(textGeometry, textMaterial);
            textMesh.position.set(0, 0, 0.6);
            scene.add(textMesh);
        } else {
            // For other 3D formats, show a placeholder
            const geometry = new THREE.SphereGeometry(0.5, 32, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x0066cc });
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
        }

        camera.position.z = 3;

        // Add controls for rotation
        let mouseX = 0, mouseY = 0;
        let isMouseDown = false;

        container.addEventListener('mousedown', (event) => {
            isMouseDown = true;
        });

        container.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        container.addEventListener('mousemove', (event) => {
            if (isMouseDown) {
                mouseX = (event.clientX / container.offsetWidth) * 2 - 1;
                mouseY = -(event.clientY / container.offsetHeight) * 2 + 1;
                
                // Rotate the first mesh in the scene
                if (scene.children.length > 0) {
                    const mesh = scene.children.find(child => child instanceof THREE.Mesh);
                    if (mesh) {
                        mesh.rotation.y = mouseX * Math.PI;
                        mesh.rotation.x = mouseY * Math.PI;
                    }
                }
            }
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // Store scene reference for cleanup
        window.scene = scene;

        // Show the preview
        loadingSpinner.style.display = 'none';
        previewContent.style.display = 'block';
        threejsContainer.style.display = 'block';
    }

    function loadPDFPreview(fileUrl) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');
        const pdfContainer = document.getElementById('pdf-container');
        const pdfViewer = document.getElementById('pdf-viewer');

        // Use Google Docs viewer for PDF preview
        pdfViewer.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(fileUrl) + '&embedded=true';
        
        loadingSpinner.style.display = 'none';
        previewContent.style.display = 'block';
        pdfContainer.style.display = 'block';
    }

    function loadImagePreview(fileUrl) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewContent = document.getElementById('previewContent');
        const imageContainer = document.getElementById('image-container');
        const previewImage = document.getElementById('preview-image');

        previewImage.src = fileUrl;
        previewImage.onload = function() {
            loadingSpinner.style.display = 'none';
            previewContent.style.display = 'block';
            imageContainer.style.display = 'block';
        };
        previewImage.onerror = function() {
            showPreviewError();
        };
    }

    function showPreviewError() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewError = document.getElementById('previewError');
        
        loadingSpinner.style.display = 'none';
        previewError.style.display = 'block';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('previewModal');
        if (event.target === modal) {
            closePreview();
        }
    }
    </script>

    {% endblock content %}